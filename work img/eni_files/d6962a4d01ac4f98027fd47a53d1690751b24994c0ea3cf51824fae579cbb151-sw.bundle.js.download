(()=>{var p={maptiles:"https://tiles.search.brave.com/maptiles",production:!0,watch_mode:!1};var{document:g,cookieStore:w}=self,t=p.production?()=>{}:console.log.bind(console,"[sw]"),b=console.error.bind(console,"[sw]");g?m():x();function m(){if(navigator.serviceWorker&&navigator.brave){t("registerSW function called");let r=g.currentScript.src;navigator.serviceWorker.register(r,{scope:"/"}).then(e=>{e.installing?t("Service worker installing"):e.waiting?t("Service worker installed"):e.active&&t("Service worker active"),e.addEventListener("updatefound",()=>{t("SW updated.")})}).catch(e=>{t("Service worker registration failed:",e)})}}function v(r){return r.replace("<main ",'<main class="d-invisible" ').replace("<main>",'<main class="d-invisible">')}function k(r,e){let n=r.indexOf('id="js-gmix"');return n!==-1?`${r.slice(0,n)} data-sw="${encodeURIComponent(e)}" ${r.slice(n)}`:r}async function y(r,e,n){let i=new URL(e.url);i.searchParams.set("is_fallback_api_available",n?"true":"false");let a=fetch(new Request(i.href,{method:e.method,headers:e.headers,mode:"same-origin",credentials:e.credentials,cache:e.cache,redirect:e.redirect,referrer:e.referrer,integrity:e.integrity,body:e.body}));try{if((await w.get("fallback"))?.value!=="1")return t("user did not opt-in to fallback. Abort!"),a;let{found:o,error:u,country:c,language:l,safesearch:d}=await S(r,i);if(t("can answer query?",r,o,u),u)return t("can answer query error"),a;if(!o){t("fallback with parameters",{country:c,language:l});let f;try{f=await self.brave.fetchBackupResults(r,l||"",c||"","")}catch(s){if(s.message==="Insufficient number of arguments.")f=await self.brave.fetchBackupResults(r,l||"",c||"","",d!=="off");else throw s}if(f){t("got backup results for",r,f.length);let s=await a;if(s.type!=="basic")return s;let h=await s.text();return h.indexOf('id="js-gmix"')!==-1?new Response(v(k(h,f)),{status:s.status,statusText:s.statusText,headers:s.headers}):(t("couldn't find js-gmix bundle"),new Response(h,{status:s.status,statusText:s.statusText,headers:s.headers}))}else t("failed to fetch backup results");return a}return a}catch(o){t("unexpected error",o)}return a}async function R(r,e,n){try{return y(r,e,n)}catch(i){b("respondWith error",i)}return fetch(e)}function x(){let r=!1;self.brave?.fetchBackupResults?(t("using native browser API"),r=!0):t("no native browser API"),self.addEventListener("install",()=>{t("got install event"),self.skipWaiting()}),self.addEventListener("fetch",async e=>{if(e.clientId)return;if(!r){t("fallback API is not available. Abort!");return}if(!w){t("cookie store is not available. Abort!");return}let n=new URL(e.request.url);if(n.pathname!=="/search"){t("ignoring pathname different from /search",n.pathname);return}let i=n.searchParams.get("q");if(!i){t("ignoring request without a query");return}t("got fetch event",n.searchParams,e),e.respondWith(R(i,e.request,r))})}async function S(r,{searchParams:e}){let n=`/api/can_answer?q=${encodeURIComponent(r)}`;e.has("country")&&(n+=`&country=${encodeURIComponent(e.get("country"))}`),e.has("lang")&&(n+=`&language=${encodeURIComponent(e.get("lang"))}`),e.has("safesearch")&&(n+=`&safesearch=${encodeURIComponent(e.get("safesearch"))}`);let i=Date.now(),a;try{a=await(await fetch(n,{method:"GET",credentials:"include",cache:"no-cache"})).json()}catch(d){return t("error fetching can_answer",d),{error:!0}}let o=Date.now();if(t("Got answer from /can_answer",o-i,a),!("found"in a))return{error:!0};let{language:u,country:c,safesearch:l}=a;return{found:!!a.found,found_fresh:!!a.found_fresh,language:u,country:c==="all"?"us":c,safesearch:l}}})();
